name: Deploy to Ubuntu Server

on:
  push:
    branches: [master]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies and build
        run: |
          bun install
          cd packages/frontend && bun run build
          cd ../backend && bun run build
          cd ../worker && bun run build
          cd ../..

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            # Navigate to project in web directory
            cd /var/www/window-explorer

            # Ensure bun is in PATH (add to .bashrc if needed)
            export PATH="$HOME/.bun/bin:$PATH"

            # Pull latest code
            git pull origin master

            # Install dependencies
            bun install

            # Generate Prisma client
            cd packages/backend
            bun prisma generate
            cd ../..

            # Run database migrations
            cd packages/backend
            bun prisma migrate deploy
            cd ../..

            # Update and restart infrastructure services
            sudo docker compose -f docker-compose.infra.yml up -d

            # Wait for infrastructure to be ready (especially database)
            echo "Waiting for infrastructure to be ready..."
            sleep 30

            # Check if infrastructure services are running
            sudo docker compose -f docker-compose.infra.yml ps

            # Build packages
            cd packages/frontend && bun run build
            cd ../backend && bun run build
            cd ../worker && bun run build
            cd ../..

            # Ensure PM2 is in PATH and start/reload processes
            export PATH="$HOME/.npm-global/bin:$PATH"
            pm2 reload all || pm2 start ecosystem.config.js

            # Wait for processes to start
            sleep 10

            # Check PM2 status
            pm2 status

            echo "Deployment completed!"
